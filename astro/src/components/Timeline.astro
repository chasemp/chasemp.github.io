---
const { items } = Astro.props as { items: any[] };

const sorted = [...items].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
---

<section class="timeline" aria-label="Timeline">
  <ol class="list" role="list">
    {sorted.map((item) => (
      <li class={`row type-${item.type}`} data-type={item.type} data-id={item.id}>
        <div class="spine">
          <span class="dot" data-dot-type={item.type} data-timestamp={item.timestamp} title={new Date(item.timestamp).toLocaleString()}></span>
        </div>
        <button class="card" data-id={item.id} data-type={item.type} data-url={item.type === 'blog' ? `/blog/${item.id.replace('blog:', '')}` : (item.url || '')} aria-haspopup="dialog">
          <div class="meta">
            <span class="type">{item.type}</span>
            <time datetime={item.timestamp}>{new Date(item.timestamp).toLocaleString()}</time>
          </div>
          <div class="title">{item.title}</div>
          {item.summary && <p class="summary">{item.summary}</p>}
        </button>
      </li>
    ))}
  </ol>

  <div class="backdrop" id="panel-backdrop" hidden></div>
  <aside class="panel" id="detail-panel" role="complementary" aria-labelledby="panel-title">
    <header class="panel-header">
      <h2 id="panel-title">About</h2>
      <button id="panel-close" aria-label="Close" hidden>×</button>
    </header>
    <div id="panel-content">
      <div class="intro">
        <h3>Welcome to my timeline</h3>
        <p>This is a chronological archive of my online presence, bringing together different content streams into a single unified view.</p>
        
        <h4>Content Types</h4>
        <ul class="legend">
          <li><span class="legend-dot" data-dot-type="blog"></span> <strong>Blog Posts</strong> — Technical writing and essays</li>
          <li><span class="legend-dot" data-dot-type="saved"></span> <strong>Saved Articles</strong> — Bookmarks from Readwise</li>
          <li><span class="legend-dot" data-dot-type="bluesky"></span> <strong>Bluesky</strong> — Social media posts and thoughts</li>
          <li><span class="legend-dot" data-dot-type="release"></span> <strong>Releases</strong> — GitHub project releases and tags</li>
        </ul>
        
        <h4>How to Use</h4>
        <p>Click on any item in the timeline to read more. Use the filters above to show or hide different content types. Hover over the colored dots to see timestamps.</p>
        
        <p class="muted-text">Built with Astro • Data fetched from multiple sources</p>
      </div>
    </div>
  </aside>

  <div id="tooltip" role="tooltip" hidden>
    <div class="tooltip-card">
      <div class="tooltip-title"></div>
      <div class="tooltip-meta"></div>
    </div>
  </div>
</section>

<style>
  .timeline { display: grid; grid-template-columns: 1fr minmax(320px, 420px); gap: 24px; }
  .list { list-style: none; margin: 0; padding: 0; position: relative; }
  .row { display: grid; grid-template-columns: 24px 1fr; gap: 12px; align-items: start; margin: 12px 0; }
  .spine { position: relative; height: 100%; }
  .spine::before { content: ""; position: absolute; top: 0; bottom: 0; left: 11px; width: 2px; background: var(--spine); }
  .dot { position: absolute; left: 5px; top: 10px; width: 12px; height: 12px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 2px #0b1220; cursor: help; transition: transform 0.2s, box-shadow 0.2s; }
  .dot:hover { transform: scale(1.3); box-shadow: 0 0 0 3px #0b1220, 0 0 8px currentColor; }
  .dot[data-dot-type="blog"] { background: #1a1a1a; color: #1a1a1a; border: 1px solid #4a4a4a; }
  .dot[data-dot-type="saved"] { background: #10b981; color: #10b981; }
  .dot[data-dot-type="bluesky"] { background: #0085ff; color: #0085ff; }
  .dot[data-dot-type="release"] { background: #f59e0b; color: #f59e0b; }
  .card { text-align: left; background: var(--panel); color: var(--text); border: 1px solid #1f2937; border-radius: 10px; padding: 12px; cursor: pointer; width: 100%; }
  .card:hover { border-color: #334155; }
  .card-link { display: block; text-decoration: none; }
  .meta { display: flex; gap: 10px; font-size: 12px; color: var(--muted); }
  .type { text-transform: uppercase; letter-spacing: .06em; }
  .title { font-weight: 600; margin-top: 6px; }
  .summary { margin: 6px 0 0; color: var(--muted); }
  .panel { position: sticky; top: 12px; align-self: start; height: calc(100dvh - 24px); background: var(--panel); border: 1px solid #1f2937; border-radius: 12px; padding: 16px; overflow: auto; }
  .panel-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1f2937; padding-bottom: 12px; margin-bottom: 16px; }
  .panel-header h2 { margin: 0; font-size: 20px; }
  #panel-close { background: transparent; color: var(--text); border: 1px solid #334155; border-radius: 6px; padding: 4px 10px; cursor: pointer; font-size: 18px; line-height: 1; }
  #panel-close:hover { background: #1f2937; }
  #panel-content { line-height: 1.6; }
  #panel-content h3 { margin: 0 0 12px; font-size: 18px; }
  #panel-content h4 { margin: 20px 0 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }
  #panel-content p { margin: 8px 0; color: var(--text); }
  #panel-content a { color: #60a5fa; text-decoration: none; }
  #panel-content a:hover { text-decoration: underline; }
  .muted-text { color: var(--muted); font-size: 13px; margin-top: 20px; }
  .legend { list-style: none; padding: 0; margin: 8px 0; }
  .legend li { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
  .legend-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
  .legend-dot[data-dot-type="blog"] { background: #1a1a1a; border: 1px solid #4a4a4a; }
  .legend-dot[data-dot-type="saved"] { background: #10b981; }
  .legend-dot[data-dot-type="bluesky"] { background: #0085ff; }
  .legend-dot[data-dot-type="release"] { background: #f59e0b; }
  .detail-meta { font-size: 13px; color: var(--muted); margin-bottom: 12px; }
  .detail-title { font-size: 22px; font-weight: 600; margin: 0 0 16px; line-height: 1.3; }
  .detail-content { color: var(--text); }
  .detail-content img { max-width: 100%; height: auto; border-radius: 8px; margin: 12px 0; }
  .detail-link { display: inline-block; margin-top: 16px; padding: 8px 16px; background: #1f2937; border: 1px solid #334155; border-radius: 6px; color: var(--text); text-decoration: none; }
  .detail-link:hover { background: #2a3441; }
  .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 49; }
  .backdrop[hidden] { display: none; }

  @media (max-width: 980px) {
    .timeline { grid-template-columns: 1fr; }
    .panel { position: fixed; inset: 0; z-index: 50; border-radius: 0; height: 100dvh; display: none; }
    .panel.mobile-open { display: block; }
    #panel-close { display: block !important; }
  }

  #tooltip { position: fixed; z-index: 60; pointer-events: none; }
  .tooltip-card { background: var(--panel); border: 1px solid #1f2937; border-radius: 8px; padding: 8px 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.35); max-width: 360px; }
  .tooltip-title { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
  .tooltip-meta { font-size: 12px; color: var(--muted); }
 </style>

<script is:inline set:html={`window.__TIMELINE__ = ${JSON.stringify(sorted)};`} />

<script>
  const params = new URLSearchParams(location.search);
  const typesParam = (params.get('types') ?? '').split(',').filter(Boolean);

  function applyFilters() {
    const allowed = new Set(typesParam.length ? typesParam : Array.from(document.querySelectorAll('input[name="type"]')).map(i=>i.value));
    document.querySelectorAll('.row').forEach((row) => {
      const t = (row as HTMLElement).dataset.type;
      (row as HTMLElement).style.display = allowed.has(t!) ? '' : 'none';
    });
  }
  applyFilters();
  document.addEventListener('filters:changed', (e: any) => {
    const allowed = new Set(e.detail.types);
    document.querySelectorAll('.row').forEach((row) => {
      const t = (row as HTMLElement).dataset.type;
      (row as HTMLElement).style.display = allowed.has(t!) ? '' : 'none';
    });
  });

  const panel = document.getElementById('detail-panel')!;
  const panelContent = document.getElementById('panel-content')!;
  const panelTitle = document.getElementById('panel-title')!;
  const closeBtn = document.getElementById('panel-close')!;
  const backdrop = document.getElementById('panel-backdrop')!;
  const isMobile = () => window.innerWidth <= 980;

  const introHTML = panelContent.innerHTML; // Save intro content

  function lockScroll(lock = true) {
    if (lock && isMobile()) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
  }

  async function loadBlogPost(url: string): Promise<string> {
    try {
      const response = await fetch(url);
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const article = doc.querySelector('article') || doc.querySelector('main') || doc.querySelector('.content');
      return article ? article.innerHTML : '<p>Unable to load content</p>';
    } catch {
      return '<p>Error loading content</p>';
    }
  }

  async function openPanelFor(id: string) {
    const entry = (window as any).__TIMELINE__.find((i: any) => i.id === id);
    if (!entry) return;
    
    // Mobile: show backdrop and lock scroll
    if (isMobile()) {
      backdrop.removeAttribute('hidden');
      panel.classList.add('mobile-open');
      closeBtn.removeAttribute('hidden');
      lockScroll(true);
    } else {
      closeBtn.setAttribute('hidden', '');
    }

    panelTitle.textContent = 'Details';
    
    // Show loading state
    panelContent.innerHTML = '<p>Loading...</p>';
    
    // Load content based on type
    let content = '';
    if (entry.type === 'blog') {
      const blogUrl = `/blog/${entry.id.replace('blog:', '')}`;
      const blogContent = await loadBlogPost(blogUrl);
      content = `<div class="detail-meta">${entry.type.toUpperCase()} · ${new Date(entry.timestamp).toLocaleString()}</div>
        <h3 class="detail-title">${entry.title || ''}</h3>
        <div class="detail-content">${blogContent}</div>`;
    } else {
      content = `<div class="detail-meta">${entry.type.toUpperCase()} · ${new Date(entry.timestamp).toLocaleString()}</div>
        <h3 class="detail-title">${entry.title || ''}</h3>
        <div class="detail-content">${entry.content_html || `<p>${entry.summary || ''}</p>`}</div>
        ${entry.url ? `<a href="${entry.url}" target="_blank" rel="noopener" class="detail-link">Open source ↗</a>` : ''}`;
    }
    
    panelContent.innerHTML = content;
    
    const p = new URLSearchParams(location.search); 
    p.set('id', id); 
    history.replaceState({}, '', `?${p.toString()}`);
  }

  function closePanel() {
    if (isMobile()) {
      backdrop.setAttribute('hidden', '');
      panel.classList.remove('mobile-open');
      lockScroll(false);
    }
    panelTitle.textContent = 'About';
    panelContent.innerHTML = introHTML;
    closeBtn.setAttribute('hidden', '');
    const p = new URLSearchParams(location.search); 
    p.delete('id'); 
    history.replaceState({}, '', `?${p.toString()}`);
  }

  closeBtn.addEventListener('click', closePanel);
  backdrop.addEventListener('click', closePanel);
  document.addEventListener('keydown', (e) => { 
    if (e.key === 'Escape' && (isMobile() ? panel.classList.contains('mobile-open') : panelContent.innerHTML !== introHTML)) {
      closePanel();
    }
  });

  // Add click handlers to all cards
  document.querySelectorAll('.card').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      openPanelFor((btn as HTMLElement).dataset.id!);
    });
  });

  // Tooltip
  const tooltip = document.getElementById('tooltip') as HTMLElement;
  const ttTitle = tooltip.querySelector('.tooltip-title') as HTMLElement;
  const ttMeta = tooltip.querySelector('.tooltip-meta') as HTMLElement;

  function positionTooltip(rect: DOMRect) {
    const gap = 10;
    const top = Math.min(window.innerHeight - 80, Math.max(0, rect.top + window.scrollY + gap));
    const left = Math.min(window.innerWidth - 380, Math.max(0, rect.left + window.scrollX + gap));
    tooltip.style.top = `${top}px`;
    tooltip.style.left = `${left}px`;
  }

  function showTooltipFor(el: HTMLElement) {
    const id = el.dataset.id!;
    const entry = (window as any).__TIMELINE__.find((i: any) => i.id === id);
    if (!entry) return;
    el.setAttribute('aria-describedby', 'tooltip');
    ttTitle.textContent = entry.title || '';
    const date = new Date(entry.timestamp).toLocaleString();
    ttMeta.textContent = `${entry.type} · ${date}`;
    positionTooltip(el.getBoundingClientRect());
    tooltip.removeAttribute('hidden');
  }
  function hideTooltipFor(el: HTMLElement) {
    el.removeAttribute('aria-describedby');
    tooltip.setAttribute('hidden', '');
  }

  // Tooltips work for all cards (both links and buttons)
  document.querySelectorAll('.card').forEach((el) => {
    const h = el as HTMLElement;
    h.addEventListener('mouseenter', () => showTooltipFor(h));
    h.addEventListener('mouseleave', () => hideTooltipFor(h));
    h.addEventListener('focus', () => showTooltipFor(h));
    h.addEventListener('blur', () => hideTooltipFor(h));
  });

  // Enhanced tooltips for dots showing date
  function showDotTooltip(dot: HTMLElement) {
    const timestamp = dot.dataset.timestamp!;
    const type = dot.dataset.dotType!;
    const date = new Date(timestamp).toLocaleString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
    ttTitle.textContent = type.toUpperCase();
    ttMeta.textContent = date;
    positionTooltip(dot.getBoundingClientRect());
    tooltip.removeAttribute('hidden');
  }
  function hideDotTooltip() {
    tooltip.setAttribute('hidden', '');
  }

  document.querySelectorAll('.dot').forEach((dot) => {
    const d = dot as HTMLElement;
    d.addEventListener('mouseenter', () => showDotTooltip(d));
    d.addEventListener('mouseleave', hideDotTooltip);
  });

  const selectedId = params.get('id');
  if (selectedId) openPanelFor(selectedId);
</script>

